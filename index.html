<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quickly Report Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='20' font-size='20'>üìã</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.3), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(72, 118, 255, 0.3), transparent 50%);
            pointer-events: none;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            padding: 40px;
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .header .icon {
            font-size: 2.5rem;
            color: #667eea;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .header .subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .section {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.08);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i,
        .section-title .material-symbols-outlined {
            color: #667eea;
            font-size: 1.5rem;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            color: #1f2937;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Inter', sans-serif;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 42px;
            line-height: 1.5;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .input-group input[type="file"] {
            padding: 12px;
            cursor: pointer;
            border: 2px dashed #d1d5db;
            background: #f9fafb;
        }
        
        .input-group input[type="file"]:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .input-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 20px;
            padding-right: 40px;
        }
        
        #imageCanvas {
            border: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            display: block;
            width: 100%;
            height: auto;
            touch-action: none;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .canvas-section {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .canvas-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .canvas-title i {
            color: #667eea;
        }
        
        .drawing-controls {
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .mode-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 12px 24px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .mode-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .mode-btn i {
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        
        .mode-btn span {
            position: relative;
            z-index: 1;
        }
        
        .btn-undo {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: #f59e0b;
            color: white;
        }
        
        .btn-undo:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #d97706;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
        }
        
        .btn-clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #dc2626;
            color: white;
        }
        
        .btn-clear:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-color: #b91c1c;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }
        
        #textDrawingInput {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }
        
        #textDrawingInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #059669;
            color: white;
            padding: 16px 32px;
            font-size: 1.15rem;
            font-weight: 700;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 32px;
        }
        
        .btn-save::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-save:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-save:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #047857;
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }
        
        .btn-save:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
        
        .btn-save i,
        .btn-save span {
            position: relative;
            z-index: 1;
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        #statusMessage {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 24px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-controls {
                flex-direction: column;
            }
            
            .mode-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 640px) {
            .header .subtitle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="material-symbols-outlined icon">quick_reference</span>
                Quickly Report
            </h1>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-edit"></i>
                ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="areaInput">Plant</label>
                    <select id="areaInput">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plant --</option>
                        <option value="GSP1">GSP1</option>
                        <option value="GSP2">GSP2</option>
                        <option value="GSP3">GSP3</option>
                        <option value="GSP5">GSP5</option>
                        <option value="GSP6">GSP6</option>
                        <option value="ESP">ESP</option>
                        <option value="TANK FARM">TANK FARM</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="areaTextInput">Area</label>
                    <input type="text" id="areaTextInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Area">
                </div>
                <div class="input-group">
                    <label for="titleJobInput">Title job</label>
                    <input type="text" id="titleJobInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Title job">
                </div>
                <div class="input-group">
                    <label for="titleJopInput">Job Description</label>
                    <textarea id="titleJopInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Job description" rows="1" style="resize: vertical; overflow: hidden; min-height: 42px;"></textarea>
                </div>
                <div class="input-group">
                    <label for="sapNoInput">SAP No.</label>
                    <input type="text" id="sapNoInput" inputmode="numeric" pattern="[0-9]*" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç">
                </div>
                <div class="input-group">
                    <label for="dateInput">Date</label>
                    <input type="date" id="dateInput">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-images"></i>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                <span style="font-size: 0.85rem; font-weight: 500; color: #6b7280;">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</span>
            </h2>
            <div class="input-group">
                <input type="file" id="fileInput" multiple accept="image/*">
            </div>
            <p id="statusMessage" class="hidden">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</p>
        </div>

        <div class="canvas-section">
            <h2 class="canvas-title">
                <i class="fas fa-eye"></i>
                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Report
            </h2>
            <canvas id="imageCanvas"></canvas>

            <div class="drawing-controls">
                <div class="mode-controls">
                    <button id="modeRect" class="mode-btn">
                        <i class="fas fa-vector-square"></i>
                        <span>‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</span>
                    </button>
                    <button id="modeCircle" class="mode-btn">
                        <i class="far fa-circle"></i>
                        <span>‡∏ß‡∏á‡∏Å‡∏•‡∏°</span>
                    </button>
                    <button id="modeArrow" class="mode-btn">
                        <i class="fas fa-long-arrow-alt-right"></i>
                        <span>‡∏•‡∏π‡∏Å‡∏®‡∏£</span>
                    </button>
                    <button id="modeText" class="mode-btn">
                        <i class="fas fa-font"></i>
                        <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                    </button>
                </div>
                <input type="text" id="textDrawingInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£... (‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô canvas)" class="hidden">
                <div class="mode-controls">
                    <button id="btnUndo" class="mode-btn btn-undo">
                        <i class="fas fa-undo"></i>
                        <span>Undo</span>
                    </button>
                    <button id="btnClear" class="mode-btn btn-clear">
                        <i class="fas fa-trash-alt"></i>
                        <span>‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ß‡∏≤‡∏î</span>
                    </button>
                </div>
            </div>
        </div>

        <button id="saveButton" class="btn-save">
            <span id="saveButtonContent">
                <i class="fas fa-save"></i>
                Save
            </span>
        </button>
    </div>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let startX, startY;
        let currentMode = null;
        let shapes = [];
        let mainImages = [];
        let backgroundImage = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        let logoImage = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö drag & drop ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        let isDraggingImage = false;
        let draggedImageIndex = -1;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö resize ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        let hoveredImageIndex = -1;
        let initialPinchDistance = 0;
        let initialImageSize = { width: 0, height: 0 };

        canvas.width = 2400;
        canvas.height = 1600;
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        function loadBackgroundImage() {
            const bgImg = new Image();
            bgImg.onload = function() {
                backgroundImage = bgImg;
                redrawCanvas();
            };
            bgImg.onerror = function() {
                console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á pttp.png ‡πÑ‡∏î‡πâ');
            };
            bgImg.src = 'pttp.png'; // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ
        function loadLogoImage() {
            const logoImg = new Image();
            logoImg.onload = function() {
                logoImage = logoImg;
                redrawCanvas();
            };
            logoImg.onerror = function() {
                console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ logoptt.png ‡πÑ‡∏î‡πâ');
            };
            logoImg.src = 'logoptt.png'; // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ
        }
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡πÇ‡∏Å‡πâ
        loadBackgroundImage();
        loadLogoImage();

        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (backgroundImage) {
                // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° canvas
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                ctx.fillStyle = '#F5F5F5';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) - ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤
            if (logoImage) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤)
                const logoMaxWidth = 320; // 160 * 2
                const logoMaxHeight = 160; // 80 * 2
                const logoRatio = logoImage.width / logoImage.height;
                
                let logoWidth, logoHeight;
                if (logoRatio > logoMaxWidth / logoMaxHeight) {
                    logoWidth = logoMaxWidth;
                    logoHeight = logoMaxWidth / logoRatio;
                } else {
                    logoHeight = logoMaxHeight;
                    logoWidth = logoMaxHeight * logoRatio;
                }
                
                // ‡∏ß‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
                const logoX = canvas.width - logoWidth - 40; // ‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ 40px (20 * 2)
                const logoY = window.logoStartY || 80; // ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡πÉ‡∏´‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                ctx.globalAlpha = 0.9;
                ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);
                ctx.globalAlpha = 1.0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
            }
            
            mainImages.forEach(img => {
                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 30; // 15 * 2
                ctx.shadowOffsetX = 10; // 5 * 2
                ctx.shadowOffsetY = 10; // 5 * 2
                ctx.drawImage(img.image, img.x, img.y, img.width, img.height);
                ctx.restore();
            });
            
            drawTemplateData();
            
            shapes.forEach(shape => {
                drawShape(shape);
            });
        }

        function drawTemplateData() {
            const area = document.getElementById('areaInput').value;
            const areaText = document.getElementById('areaTextInput').value;
            const titleJob = document.getElementById('titleJobInput').value;
            const jobDescription = document.getElementById('titleJopInput').value;
            const sapNo = document.getElementById('sapNoInput').value;
            const dateValue = document.getElementById('dateInput').value;
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å YYYY-MM-DD ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
            let date = '';
            if (dateValue) {
                const dateParts = dateValue.split('-');
                if (dateParts.length === 3) {
                    date = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                }
            }
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö force break)
            function wrapText(text, maxWidth) {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';
                
                for (let word of words) {
                    const testLine = currentLine + (currentLine ? ' ' : '') + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                    
                    // Force break: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô maxWidth ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                    if (ctx.measureText(currentLine).width > maxWidth) {
                        let chars = currentLine.split('');
                        let tempLine = '';
                        
                        for (let char of chars) {
                            const testChar = tempLine + char;
                            if (ctx.measureText(testChar).width > maxWidth) {
                                if (tempLine) lines.push(tempLine);
                                tempLine = char;
                            } else {
                                tempLine = testChar;
                            }
                        }
                        currentLine = tempLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            ctx.fillStyle = '#000000';
            
            let yPos = 80; // 40 * 2
            let yPosRight = 80; // 40 * 2
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ
            window.logoStartY = yPosRight; // Y = 80
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏ä‡πâ
            const logoEstimatedHeight = 160; // 80 * 2
            
            // Operation Report ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡πÇ‡∏î‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 30px (15 * 2)
            yPosRight = yPosRight + logoEstimatedHeight + 30;
            
            // ‡∏ß‡∏≤‡∏î Operation Report
            ctx.font = 'bold 72px Inter'; // 36 * 2
            ctx.textAlign = 'right';
            ctx.fillText('Operation Report', canvas.width - 40, yPosRight); // margin 20 * 2
            
            yPosRight += 70; // 35 * 2
            
            // SAP No. ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á Operation Report
            ctx.font = 'bold 44px Inter'; // 22 * 2
            ctx.fillStyle = '#000000';
            
            if (sapNo) {
                // ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç SAP
                ctx.font = '44px Inter'; // 22 * 2
                ctx.fillStyle = '#ff0000';
                const sapNumberWidth = ctx.measureText(sapNo).width;
                
                // ‡∏ß‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç SAP (‡∏™‡∏µ‡πÅ‡∏î‡∏á) 
                ctx.fillText(sapNo, canvas.width - 40, yPosRight); // margin 20 * 2
                
                // ‡∏ß‡∏≤‡∏î "SAP No. :" ‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                ctx.font = 'bold 44px Inter'; // 22 * 2
                ctx.fillStyle = '#000000';
                ctx.fillText('SAP No. :', canvas.width - 40 - sapNumberWidth - 20, yPosRight); // margin 20 * 2
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç SAP ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà label
                ctx.fillText('SAP No. :', canvas.width - 40, yPosRight); // margin 20 * 2
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï textAlign ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢
            ctx.textAlign = 'left';
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≤‡∏¢
            ctx.font = 'bold 44px Inter'; // 22 * 2
            
            // Plant ‡πÅ‡∏•‡∏∞ Area (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
            ctx.fillText('Plant :', 40, yPos); // margin 20 * 2
            let xPos = 220; // 110 * 2
            if (area) {
                ctx.font = '44px Inter'; // 22 * 2
                ctx.fillText(area, xPos, yPos);
                xPos += ctx.measureText(area).width + 40; // 20 * 2
                ctx.font = 'bold 44px Inter'; // 22 * 2
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á Area ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ Plant
            if (areaText) {
                ctx.font = 'bold 44px Inter'; // 22 * 2
                ctx.fillText('Area :', xPos, yPos);
                xPos += ctx.measureText('Area :').width + 20; // 10 * 2
                ctx.font = '44px Inter'; // 22 * 2
                ctx.fillText(areaText, xPos, yPos);
                ctx.font = 'bold 44px Inter'; // 22 * 2
            }
            yPos += 70; // 35 * 2
            
            // Title job
            ctx.fillText('Title job :', 40, yPos); // margin 20 * 2
            if (titleJob) {
                ctx.font = '44px Inter'; // 22 * 2
                ctx.fillText(titleJob, 290, yPos); // 145 * 2
                ctx.font = 'bold 44px Inter'; // 22 * 2
            }
            yPos += 70; // 35 * 2
            
            // Date (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô Job description)
            ctx.fillText('Date :', 40, yPos); // margin 20 * 2
            if (date) {
                ctx.font = '44px Inter'; // 22 * 2
                ctx.fillText(date, 200, yPos); // 100 * 2
                ctx.font = 'bold 44px Inter'; // 22 * 2
            }
            yPos += 70; // 35 * 2
            
            // Job description (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
            ctx.font = 'bold 44px Inter'; // 22 * 2
            const jobDescLabel = 'Job description :';
            const jobDescLabelWidth = ctx.measureText(jobDescLabel).width;
            ctx.fillText(jobDescLabel, 40, yPos); // margin 20 * 2
            
            if (jobDescription) {
                ctx.font = '44px Inter'; // 22 * 2
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô 1300px
                const textStartX = 40 + jobDescLabelWidth + 20;
                const maxTextWidth = 1300; // 1300px (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö force break ‡πÅ‡∏•‡πâ‡∏ß)
                
                // ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                const lines = wrapText(jobDescription, maxTextWidth);
                
                // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                lines.forEach((line, index) => {
                    ctx.fillText(line, textStartX, yPos + (index * 70)); // 70 = ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (35 * 2)
                });
                
                ctx.font = 'bold 44px Inter'; // 22 * 2
            }
        }

        function drawShape(shape) {
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 12; // 6 * 2
            ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';

            switch (shape.type) {
                case 'rect':
                    ctx.strokeRect(shape.x, shape.y, shape.width, shape.height);
                    ctx.fillRect(shape.x, shape.y, shape.width, shape.height);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(shape.width, 2) + Math.pow(shape.height, 2)) / 2;
                    ctx.beginPath();
                    ctx.arc(shape.x + shape.width/2, shape.y + shape.height/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fill();
                    break;
                case 'arrow':
                    drawArrow(shape.x, shape.y, shape.x + shape.width, shape.y + shape.height);
                    break;
                case 'text':
                    // ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    ctx.font = 'bold 48px Inter'; // 24 * 2
                    const textMetrics = ctx.measureText(shape.text);
                    const textHeight = 48; // 24 * 2
                    const padding = 10; // 5 * 2
                    
                    // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(
                        shape.x - padding, 
                        shape.y - textHeight, 
                        textMetrics.width + (padding * 2), 
                        textHeight + (padding * 2)
                    );
                    
                    // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    ctx.fillStyle = '#ff0000';
                    ctx.fillText(shape.text, shape.x, shape.y);
                    break;
            }
        }

        function drawArrow(fromX, fromY, toX, toY) {
            const headLength = 30; // 15 * 2
            const angle = Math.atan2(toY - fromY, toX - fromX);

            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = '#ff0000';
            ctx.fill();
        }

        document.getElementById('modeRect').addEventListener('click', function() {
            setMode('rect', this);
        });

        document.getElementById('modeCircle').addEventListener('click', function() {
            setMode('circle', this);
        });

        document.getElementById('modeArrow').addEventListener('click', function() {
            setMode('arrow', this);
        });

        document.getElementById('modeText').addEventListener('click', function() {
            setMode('text', this);
            document.getElementById('textDrawingInput').classList.remove('hidden');
        });

        function setMode(mode, button) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (mode !== 'text') {
                document.getElementById('textDrawingInput').classList.add('hidden');
            }
        }

        function handleDrawStart(e) {
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e);
            startX = coords.x;
            startY = coords.y;
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ currentMode = ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ (‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
            if (currentMode) {
                if (currentMode === 'text') {
                    const text = document.getElementById('textDrawingInput').value;
                    if (text) {
                        shapes.push({
                            type: 'text',
                            x: startX,
                            y: startY,
                            text: text
                        });
                        redrawCanvas();
                    }
                } else {
                    isDrawing = true;
                }
                return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å function ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ mode = ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤)
            for (let i = mainImages.length - 1; i >= 0; i--) {
                const img = mainImages[i];
                if (startX >= img.x && startX <= img.x + img.width &&
                    startY >= img.y && startY <= img.y + img.height) {
                    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û - ‡πÄ‡∏£‡∏¥‡πà‡∏° drag
                    isDraggingImage = true;
                    draggedImageIndex = i;
                    dragOffsetX = startX - img.x;
                    dragOffsetY = startY - img.y;
                    canvas.style.cursor = 'grabbing';
                    return;
                }
            }
        }

        function handleDrawMove(e) {
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e);
            const currentX = coords.x;
            const currentY = coords.y;
            
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            if (isDraggingImage && draggedImageIndex !== -1) {
                const img = mainImages[draggedImageIndex];
                img.x = currentX - dragOffsetX;
                img.y = currentY - dragOffsetY;
                redrawCanvas();
                return;
            }
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô cursor ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover ‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î)
            if (!isDrawing && !isDraggingImage && !currentMode) {
                let onImage = false;
                for (let i = mainImages.length - 1; i >= 0; i--) {
                    const img = mainImages[i];
                    if (currentX >= img.x && currentX <= img.x + img.width &&
                        currentY >= img.y && currentY <= img.y + img.height) {
                        onImage = true;
                        break;
                    }
                }
                canvas.style.cursor = onImage ? 'grab' : 'default';
            }
            
            // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
            if (!isDrawing || !currentMode) return;
            
            redrawCanvas();
            
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 12; // 6 * 2
            
            switch (currentMode) {
                case 'rect':
                    ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2)) / 2;
                    ctx.beginPath();
                    ctx.arc(startX + (currentX - startX)/2, startY + (currentY - startY)/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
                case 'arrow':
                    drawArrow(startX, startY, currentX, currentY);
                    break;
            }
        }

        function handleDrawEnd(e) {
            e.preventDefault();
            
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            if (isDraggingImage) {
                isDraggingImage = false;
                draggedImageIndex = -1;
                canvas.style.cursor = 'default';
                return;
            }
            
            if (!isDrawing || !currentMode) return;
            
            const coords = getCanvasCoordinates(e);
            const endX = coords.x;
            const endY = coords.y;
            
            shapes.push({
                type: currentMode,
                x: startX,
                y: startY,
                width: endX - startX,
                height: endY - startY
            });
            
            isDrawing = false;
            redrawCanvas();
        }

        canvas.addEventListener('mousedown', handleDrawStart);
        canvas.addEventListener('mousemove', handleDrawMove);
        canvas.addEventListener('mouseup', handleDrawEnd);
        canvas.addEventListener('mouseleave', (e) => {
            if (isDrawing) {
                handleDrawEnd(e);
            }
            if (isDraggingImage) {
                isDraggingImage = false;
                draggedImageIndex = -1;
                canvas.style.cursor = 'default';
            }
        });

        canvas.addEventListener('touchstart', handleDrawStart);
        canvas.addEventListener('touchmove', handleDrawMove);
        canvas.addEventListener('touchend', handleDrawEnd);
        canvas.addEventListener('touchcancel', handleDrawEnd);
        
        // Mouse wheel zoom (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î)
        canvas.addEventListener('wheel', (e) => {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà zoom)
            if (currentMode) return;
            
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e);
            const mouseX = coords.x;
            const mouseY = coords.y;
            
            // ‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà mouse ‡∏≠‡∏¢‡∏π‡πà
            for (let i = mainImages.length - 1; i >= 0; i--) {
                const img = mainImages[i];
                if (mouseX >= img.x && mouseX <= img.x + img.width &&
                    mouseY >= img.y && mouseY <= img.y + img.height) {
                    
                    const delta = e.deltaY > 0 ? 0.9 : 1.1; // ‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å 10%
                    const oldWidth = img.width;
                    const oldHeight = img.height;
                    
                    img.width *= delta;
                    img.height *= delta;
                    
                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ã‡∏π‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà mouse ‡∏≠‡∏¢‡∏π‡πà
                    const mouseRelX = (mouseX - img.x) / oldWidth;
                    const mouseRelY = (mouseY - img.y) / oldHeight;
                    
                    img.x = mouseX - (mouseRelX * img.width);
                    img.y = mouseY - (mouseRelY * img.height);
                    
                    redrawCanvas();
                    break;
                }
            }
        }, { passive: false });
        
        // Touch pinch zoom (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î)
        canvas.addEventListener('touchstart', (e) => {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà zoom)
            if (currentMode) return;
            
            if (e.touches.length === 2) {
                e.preventDefault();
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const coords1 = getCanvasCoordinates(touch1);
                const coords2 = getCanvasCoordinates(touch2);
                
                initialPinchDistance = Math.sqrt(
                    Math.pow(coords2.x - coords1.x, 2) + 
                    Math.pow(coords2.y - coords1.y, 2)
                );
                
                const centerX = (coords1.x + coords2.x) / 2;
                const centerY = (coords1.y + coords2.y) / 2;
                
                // ‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á pinch
                for (let i = mainImages.length - 1; i >= 0; i--) {
                    const img = mainImages[i];
                    if (centerX >= img.x && centerX <= img.x + img.width &&
                        centerY >= img.y && centerY <= img.y + img.height) {
                        hoveredImageIndex = i;
                        initialImageSize = { width: img.width, height: img.height };
                        break;
                    }
                }
            }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å mode ‡∏ß‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà zoom)
            if (currentMode) return;
            
            if (e.touches.length === 2 && hoveredImageIndex !== -1) {
                e.preventDefault();
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const coords1 = getCanvasCoordinates(touch1);
                const coords2 = getCanvasCoordinates(touch2);
                
                const currentDistance = Math.sqrt(
                    Math.pow(coords2.x - coords1.x, 2) + 
                    Math.pow(coords2.y - coords1.y, 2)
                );
                
                const scale = currentDistance / initialPinchDistance;
                const img = mainImages[hoveredImageIndex];
                
                const centerX = (coords1.x + coords2.x) / 2;
                const centerY = (coords1.y + coords2.y) / 2;
                
                const oldCenterX = img.x + img.width / 2;
                const oldCenterY = img.y + img.height / 2;
                
                img.width = initialImageSize.width * scale;
                img.height = initialImageSize.height * scale;
                
                img.x = oldCenterX - img.width / 2;
                img.y = oldCenterY - img.height / 2;
                
                redrawCanvas();
            }
        }, { passive: false });
        
        canvas.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) {
                hoveredImageIndex = -1;
                initialPinchDistance = 0;
            }
        }, { passive: false });

        document.getElementById('btnUndo').addEventListener('click', () => {
            shapes.pop();
            redrawCanvas();
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            shapes = [];
            redrawCanvas();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = e.target.files;
            
            if (files.length === 0) {
                document.getElementById('statusMessage').textContent = '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)';
                document.getElementById('statusMessage').classList.remove('hidden');
                return;
            }
            
            if (files.length > 3) {
                document.getElementById('statusMessage').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('statusMessage').classList.remove('hidden');
                e.target.value = '';
                return;
            }
            
            document.getElementById('statusMessage').classList.add('hidden');
            mainImages = [];
            
            let loadedCount = 0;
            const canvasMargin = 80; // 40 * 2
            const startY = 500; // 250 * 2
            const gap = 60; // 30 * 2
            const maxHeight = canvas.height - startY - canvasMargin;
            const maxWidth = canvas.width - (canvasMargin * 2);
            
            const tempImages = [];
            
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        tempImages.push(img);
                        loadedCount++;
                        
                        if (loadedCount === files.length) {
                            let tallestHeight = 0;
                            const imageData = tempImages.map((img) => {
                                const aspectRatio = img.width / img.height;
                                let displayHeight = maxHeight;
                                let displayWidth = displayHeight * aspectRatio;
                                
                                tallestHeight = Math.max(tallestHeight, displayHeight);
                                
                                return {
                                    image: img,
                                    aspectRatio: aspectRatio,
                                    width: displayWidth,
                                    height: displayHeight
                                };
                            });
                            
                            let totalWidth = imageData.reduce((sum, data) => sum + data.width, 0) + (gap * (files.length - 1));
                            
                            if (totalWidth > maxWidth) {
                                const scaleFactor = maxWidth / totalWidth;
                                imageData.forEach(data => {
                                    data.width = data.width * scaleFactor;
                                    data.height = data.height * scaleFactor;
                                });
                                totalWidth = maxWidth;
                            }
                            
                            let currentX = (canvas.width - totalWidth) / 2;
                            
                            imageData.forEach((data) => {
                                mainImages.push({
                                    image: data.image,
                                    x: currentX,
                                    y: startY,
                                    width: data.width,
                                    height: data.height
                                });
                                
                                currentX += data.width + gap;
                            });
                            
                            redrawCanvas();
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(files[i]);
            }
        });

        document.getElementById('saveButton').addEventListener('click', () => {
            const saveButton = document.getElementById('saveButton');
            const saveButtonContent = document.getElementById('saveButtonContent');
            
            saveButton.disabled = true;
            saveButtonContent.innerHTML = '<span class="loader"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            setTimeout(() => {
                try {
                    const exportCanvas = document.createElement('canvas');
                    exportCanvas.width = canvas.width;
                    exportCanvas.height = canvas.height;
                    const exportCtx = exportCanvas.getContext('2d');
                    
                    exportCtx.drawImage(canvas, 0, 0);
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
                    const plant = document.getElementById('areaInput').value || 'NoPlant';
                    const areaText = document.getElementById('areaTextInput').value || 'NoArea';
                    const now = new Date();
                    const day = String(now.getDate()).padStart(2, '0');
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = now.getFullYear();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: Plant_Area_DD-MM-YYYY_HH-MM-SS
                    const fileName = `${plant}_${areaText}_${day}-${month}-${year}_${hours}-${minutes}-${seconds}`;
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á canvas ‡πÄ‡∏õ‡πá‡∏ô Blob ‡πÅ‡∏ó‡∏ô Data URL (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)
                    exportCanvas.toBlob((blob) => {
                        if (!blob) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
                        }
                        
                        // 1. Download ‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                        try {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = fileName + '.png';
                            link.href = url;
                            link.style.display = 'none';
                            
                            document.body.appendChild(link);
                            link.click();
                            
                            // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô cleanup
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            console.log('File download initiated:', fileName);
                        } catch (downloadError) {
                            console.warn('Download failed:', downloadError);
                            // ‡∏ñ‡πâ‡∏≤ download ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏¢‡∏±‡∏á‡∏°‡∏µ Cloudinary backup
                        }
                        
                        // 2. Upload ‡πÑ‡∏õ Cloudinary
                        const formData = new FormData();
                        formData.append('file', blob, fileName + '.png');
                        formData.append('upload_preset', 'REport-oper');
                        formData.append('folder', 'REport-oper');
                        formData.append('public_id', fileName);
                        
                        console.log('Starting Cloudinary upload...', fileName);
                        
                        fetch('https://api.cloudinary.com/v1_1/lik/image/upload', {
                            method: 'POST',
                            body: formData,
                            mode: 'cors'
                        })
                        .then(response => {
                            console.log('Cloudinary response status:', response.status);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Cloudinary upload success:', data);
                            console.log('Image URL:', data.secure_url);
                            saveButtonContent.innerHTML = '<i class="fas fa-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á + Cloud)';
                            setTimeout(() => {
                                saveButtonContent.innerHTML = '<i class="fas fa-save"></i> Save';
                                saveButton.disabled = false;
                            }, 2000);
                        })
                        .catch(error => {
                            console.error('Cloudinary upload error:', error);
                            console.error('Error details:', error.message);
                            saveButtonContent.innerHTML = '<i class="fas fa-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)';
                            setTimeout(() => {
                                saveButtonContent.innerHTML = '<i class="fas fa-save"></i> Save';
                                saveButton.disabled = false;
                            }, 2000);
                        });
                        
                    }, 'image/png', 0.95); // ‡∏•‡∏î quality ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
                    
                } catch (error) {
                    console.error('Error saving image:', error);
                    saveButtonContent.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                    setTimeout(() => {
                        saveButtonContent.innerHTML = '<i class="fas fa-save"></i> Save';
                        saveButton.disabled = false;
                    }, 2000);
                }
            }, 300);
        });

        document.getElementById('areaInput').addEventListener('change', redrawCanvas);
        document.getElementById('areaTextInput').addEventListener('input', redrawCanvas);
        document.getElementById('titleJobInput').addEventListener('input', redrawCanvas);
        
        // Auto-resize textarea ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Job description
        const jobDescTextarea = document.getElementById('titleJopInput');
        
        function autoResizeTextarea() {
            jobDescTextarea.style.height = 'auto';
            jobDescTextarea.style.height = Math.max(42, jobDescTextarea.scrollHeight) + 'px';
            redrawCanvas();
        }
        
        jobDescTextarea.addEventListener('input', autoResizeTextarea);
        
        document.getElementById('sapNoInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            redrawCanvas();
        });
        document.getElementById('dateInput').addEventListener('change', redrawCanvas);
        
        document.getElementById('dateInput').valueAsDate = new Date();
        
        redrawCanvas();
    </script>
</body>
</html>
