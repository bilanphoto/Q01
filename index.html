<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quickly Report Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .input-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group input[type="file"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            color: #1f2937;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .input-group input[type="file"] {
            padding: 8px;
            cursor: pointer;
        }
        #imageCanvas {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            display: block;
            width: 100%;
            height: auto;
            touch-action: none;
        }
        .mode-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .mode-btn:hover::before {
            left: 100%;
        }
        .mode-btn:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #2563eb;
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        .mode-btn.active:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-color: #1d4ed8;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }
        .mode-btn i {
            font-size: 1.1rem;
        }
        .btn-undo {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: #f59e0b;
            color: #ffffff;
        }
        .btn-undo:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #d97706;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
        }
        .btn-clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #dc2626;
            color: #ffffff;
        }
        .btn-clear:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-color: #b91c1c;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }
        .btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #059669;
            color: #ffffff;
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-save::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .btn-save:hover::before {
            left: 100%;
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #047857;
            transform: translateY(-3px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
        }
        .btn-save:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr !important;
            }
            .mode-controls {
                flex-wrap: wrap;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center flex items-center justify-center gap-3">
            <i class="fas fa-bolt text-blue-500"></i> Quickly Report
            <span class="text-gray-500 text-base font-normal hidden sm:inline">text grammar 8</span>
        </h1>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded-md">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">เลือกข้อมูลพื้นฐาน (Template):</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 input-grid">
                <div class="input-group">
                    <label for="areaInput" class="block text-sm">Area :</label>
                    <input type="text" id="areaInput" placeholder="กรอก Area">
                </div>
                <div class="input-group">
                    <label for="titleJopInput" class="block text-sm">Title job :</label>
                    <input type="text" id="titleJopInput" placeholder="กรอก Title job">
                </div>
                <div class="input-group">
                    <label for="sapNoInput" class="block text-sm">SAP No. :</label>
                    <input type="text" id="sapNoInput" placeholder="กรอก SAP No.">
                </div>
                <div class="input-group">
                    <label for="dateInput" class="block text-sm">Date :</label>
                    <input type="date" id="dateInput">
                </div>
            </div>
        </div>

        <div class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-4 rounded-md">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">เลือกข้อมูลรูปภาพ:</h2>
            <div class="input-group">
                <label for="fileInput" class="block text-sm mb-1">รูปภาพหลัก: (เลือกได้สูงสุด 3 รูป)</label>
                <input type="file" id="fileInput" multiple accept="image/*" class="file-input-custom">
            </div>
            <p id="statusMessage" class="text-red-500 mt-2 hidden">โปรดเลือกรูปภาพหลักอย่างน้อย 1 รูป (สูงสุด 3 รูป)</p>
        </div>


        <div class="canvas-area bg-gray-100 rounded-lg p-2 relative">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 text-center">ตัวอย่างผลลัพธ์บนพื้นที่ Canvas</h2>
            <canvas id="imageCanvas" class="rounded-md shadow-inner"></canvas>

            <div class="drawing-controls mt-4 p-3 bg-white rounded-lg shadow-sm">
                <div class="flex flex-wrap items-center justify-center gap-3 mb-3 mode-controls">
                    <button id="modeRect" class="mode-btn"><i class="fas fa-vector-square"></i> สี่เหลี่ยม</button>
                    <button id="modeCircle" class="mode-btn"><i class="far fa-circle"></i> วงกลม</button>
                    <button id="modeArrow" class="mode-btn"><i class="fas fa-long-arrow-alt-right"></i> ลูกศร</button>
                    <button id="modeText" class="mode-btn"><i class="fas fa-font"></i> ข้อความ</button>
                    <input type="text" id="textDrawingInput" placeholder="พิมพ์ข้อความที่ต้องการ...(กดคลิก)" class="flex-grow p-2 border border-gray-300 rounded-md hidden">
                </div>
                <div class="flex flex-wrap items-center justify-center gap-3">
                    <button id="btnUndo" class="mode-btn btn-undo"><i class="fas fa-undo"></i> Undo</button>
                    <button id="btnClear" class="mode-btn btn-clear"><i class="fas fa-trash-alt"></i> ล้างรูปวาด</button>
                </div>
            </div>
        </div>

        <button id="saveButton" class="mt-6 w-full btn-save flex items-center justify-center">
            <span id="saveButtonContent"><i class="fas fa-save mr-2"></i>Save Report (PNG)</span>
        </button>
    </div>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let startX, startY;
        let currentMode = null;
        let shapes = [];
        let mainImages = [];

        canvas.width = 1200;
        canvas.height = 800;

        // ฟังก์ชันแปลงพิกัดจาก mouse/touch event
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            
            // รองรับทั้ง mouse และ touch events
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#F5F5F5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            mainImages.forEach(img => {
                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 15;
                ctx.shadowOffsetX = 5;
                ctx.shadowOffsetY = 5;
                ctx.drawImage(img.image, img.x, img.y, img.width, img.height);
                ctx.restore();
            });
            
            drawTemplateData();
            
            shapes.forEach(shape => {
                drawShape(shape);
            });
        }

        function drawTemplateData() {
            const area = document.getElementById('areaInput').value;
            const titleJob = document.getElementById('titleJopInput').value;
            const sapNo = document.getElementById('sapNoInput').value;
            const date = document.getElementById('dateInput').value;

            ctx.fillStyle = '#000000';
            
            let yPos = 40;
            let yPosRight = 40;
            
            // วาด Operation Report ฝั่งขวา
            ctx.font = 'bold 28px Inter';
            ctx.fillText('Operation Report', canvas.width - 320, yPosRight);
            yPosRight += 35;
            
            // SAP No. ฝั่งขวาใต้ Operation Report (สีแดง)
            ctx.font = 'bold 22px Inter';
            ctx.fillText('SAP No. :', canvas.width - 320, yPosRight);
            if (sapNo) {
                ctx.font = '22px Inter';
                ctx.fillStyle = '#ff0000';
                ctx.fillText(sapNo, canvas.width - 185, yPosRight);
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 22px Inter';
            }
            
            // เริ่มวาดข้อมูลซ้าย
            ctx.font = 'bold 22px Inter';
            
            // Area
            ctx.fillText('Area :', 20, yPos);
            if (area) {
                ctx.font = '22px Inter';
                ctx.fillText(area, 110, yPos);
                ctx.font = 'bold 22px Inter';
            }
            yPos += 35;
            
            // Title Job
            ctx.fillText('Title job :', 20, yPos);
            if (titleJob) {
                ctx.font = '22px Inter';
                ctx.fillText(titleJob, 145, yPos);
                ctx.font = 'bold 22px Inter';
            }
            yPos += 35;
            
            // Date
            ctx.fillText('Date :', 20, yPos);
            if (date) {
                ctx.font = '22px Inter';
                ctx.fillText(date, 100, yPos);
                ctx.font = 'bold 22px Inter';
            }
            
            if (currentMode === 'text') {
                const previewText = document.getElementById('textDrawingInput').value;
                if (previewText) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.font = 'bold 24px Inter';
                    ctx.fillText(`Preview: ${previewText}`, canvas.width / 2 - 100, 50);
                    ctx.fillStyle = '#000000';
                }
            }
        }

        function drawShape(shape) {
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';

            switch (shape.type) {
                case 'rect':
                    ctx.strokeRect(shape.x, shape.y, shape.width, shape.height);
                    ctx.fillRect(shape.x, shape.y, shape.width, shape.height);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(shape.width, 2) + Math.pow(shape.height, 2)) / 2;
                    ctx.beginPath();
                    ctx.arc(shape.x + shape.width/2, shape.y + shape.height/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fill();
                    break;
                case 'arrow':
                    drawArrow(shape.x, shape.y, shape.x + shape.width, shape.y + shape.height);
                    break;
                case 'text':
                    ctx.fillStyle = '#ff0000';
                    ctx.font = 'bold 24px Inter';
                    ctx.fillText(shape.text, shape.x, shape.y);
                    break;
            }
        }

        function drawArrow(fromX, fromY, toX, toY) {
            const headLength = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);

            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = '#ff0000';
            ctx.fill();
        }

        document.getElementById('modeRect').addEventListener('click', function() {
            setMode('rect', this);
        });

        document.getElementById('modeCircle').addEventListener('click', function() {
            setMode('circle', this);
        });

        document.getElementById('modeArrow').addEventListener('click', function() {
            setMode('arrow', this);
        });

        document.getElementById('modeText').addEventListener('click', function() {
            setMode('text', this);
            document.getElementById('textDrawingInput').classList.remove('hidden');
        });

        document.getElementById('textDrawingInput').addEventListener('input', function() {
            if (currentMode === 'text') {
                redrawCanvas();
            }
        });

        function setMode(mode, button) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (mode !== 'text') {
                document.getElementById('textDrawingInput').classList.add('hidden');
            }
        }

        // ฟังก์ชันเริ่มวาด (รองรับทั้ง mouse และ touch)
        function handleDrawStart(e) {
            e.preventDefault();
            
            if (!currentMode) return;
            
            const coords = getCanvasCoordinates(e);
            startX = coords.x;
            startY = coords.y;
            
            if (currentMode === 'text') {
                const text = document.getElementById('textDrawingInput').value;
                if (text) {
                    shapes.push({
                        type: 'text',
                        x: startX,
                        y: startY,
                        text: text
                    });
                    redrawCanvas();
                }
            } else {
                isDrawing = true;
            }
        }

        // ฟังก์ชันวาดระหว่างลาก (รองรับทั้ง mouse และ touch)
        function handleDrawMove(e) {
            e.preventDefault();
            
            if (!isDrawing || !currentMode) return;
            
            const coords = getCanvasCoordinates(e);
            const currentX = coords.x;
            const currentY = coords.y;
            
            redrawCanvas();
            
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            
            switch (currentMode) {
                case 'rect':
                    ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2)) / 2;
                    ctx.beginPath();
                    ctx.arc(startX + (currentX - startX)/2, startY + (currentY - startY)/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
                case 'arrow':
                    drawArrow(startX, startY, currentX, currentY);
                    break;
            }
        }

        // ฟังก์ชันจบการวาด (รองรับทั้ง mouse และ touch)
        function handleDrawEnd(e) {
            e.preventDefault();
            
            if (!isDrawing || !currentMode) return;
            
            const coords = getCanvasCoordinates(e);
            const endX = coords.x;
            const endY = coords.y;
            
            shapes.push({
                type: currentMode,
                x: startX,
                y: startY,
                width: endX - startX,
                height: endY - startY
            });
            
            isDrawing = false;
            redrawCanvas();
        }

        // เพิ่ม Event Listeners สำหรับ Mouse
        canvas.addEventListener('mousedown', handleDrawStart);
        canvas.addEventListener('mousemove', handleDrawMove);
        canvas.addEventListener('mouseup', handleDrawEnd);
        canvas.addEventListener('mouseleave', (e) => {
            if (isDrawing) {
                handleDrawEnd(e);
            }
        });

        // เพิ่ม Event Listeners สำหรับ Touch (มือถือ/แท็บเล็ต)
        canvas.addEventListener('touchstart', handleDrawStart);
        canvas.addEventListener('touchmove', handleDrawMove);
        canvas.addEventListener('touchend', handleDrawEnd);
        canvas.addEventListener('touchcancel', handleDrawEnd);

        document.getElementById('btnUndo').addEventListener('click', () => {
            shapes.pop();
            redrawCanvas();
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            shapes = [];
            redrawCanvas();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = e.target.files;
            
            if (files.length === 0) {
                document.getElementById('statusMessage').textContent = 'โปรดเลือกรูปภาพหลักอย่างน้อย 1 รูป (สูงสุด 3 รูป)';
                document.getElementById('statusMessage').classList.remove('hidden');
                return;
            }
            
            if (files.length > 3) {
                document.getElementById('statusMessage').textContent = 'เลือกได้สูงสุด 3 รูปเท่านั้น กรุณาเลือกใหม่';
                document.getElementById('statusMessage').classList.remove('hidden');
                e.target.value = '';
                return;
            }
            
            document.getElementById('statusMessage').classList.add('hidden');
            mainImages = [];
            
            let loadedCount = 0;
            const canvasMargin = 40;
            const startY = 250;
            const gap = 30;
            const maxHeight = canvas.height - startY - canvasMargin;
            const maxWidth = canvas.width - (canvasMargin * 2);
            
            const tempImages = [];
            
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        tempImages.push(img);
                        loadedCount++;
                        
                        if (loadedCount === files.length) {
                            let tallestHeight = 0;
                            const imageData = tempImages.map((img) => {
                                const aspectRatio = img.width / img.height;
                                let displayHeight = maxHeight;
                                let displayWidth = displayHeight * aspectRatio;
                                
                                tallestHeight = Math.max(tallestHeight, displayHeight);
                                
                                return {
                                    image: img,
                                    aspectRatio: aspectRatio,
                                    width: displayWidth,
                                    height: displayHeight
                                };
                            });
                            
                            let totalWidth = imageData.reduce((sum, data) => sum + data.width, 0) + (gap * (files.length - 1));
                            
                            if (totalWidth > maxWidth) {
                                const scaleFactor = maxWidth / totalWidth;
                                imageData.forEach(data => {
                                    data.width = data.width * scaleFactor;
                                    data.height = data.height * scaleFactor;
                                });
                                totalWidth = maxWidth;
                            }
                            
                            let currentX = (canvas.width - totalWidth) / 2;
                            
                            imageData.forEach((data) => {
                                mainImages.push({
                                    image: data.image,
                                    x: currentX,
                                    y: startY,
                                    width: data.width,
                                    height: data.height
                                });
                                
                                currentX += data.width + gap;
                            });
                            
                            redrawCanvas();
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(files[i]);
            }
        });

        document.getElementById('saveButton').addEventListener('click', () => {
            const saveButton = document.getElementById('saveButton');
            const saveButtonContent = document.getElementById('saveButtonContent');
            
            saveButton.disabled = true;
            saveButtonContent.innerHTML = '<span class="loader"></span>กำลังบันทึก...';
            
            setTimeout(() => {
                try {
                    const exportCanvas = document.createElement('canvas');
                    exportCanvas.width = canvas.width;
                    exportCanvas.height = canvas.height;
                    const exportCtx = exportCanvas.getContext('2d');
                    
                    exportCtx.drawImage(canvas, 0, 0);
                    
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                    link.download = `Operation_Report_${timestamp}.png`;
                    link.href = exportCanvas.toDataURL('image/png', 1.0);
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    saveButtonContent.innerHTML = '<i class="fas fa-check mr-2"></i>บันทึกสำเร็จ!';
                    setTimeout(() => {
                        saveButtonContent.innerHTML = '<i class="fas fa-save mr-2"></i>Save Report (PNG)';
                        saveButton.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('Error saving image:', error);
                    saveButtonContent.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>เกิดข้อผิดพลาด';
                    setTimeout(() => {
                        saveButtonContent.innerHTML = '<i class="fas fa-save mr-2"></i>Save Report (PNG)';
                        saveButton.disabled = false;
                    }, 2000);
                }
            }, 300);
        });

        document.getElementById('areaInput').addEventListener('input', redrawCanvas);
        document.getElementById('titleJopInput').addEventListener('input', redrawCanvas);
        document.getElementById('sapNoInput').addEventListener('input', redrawCanvas);
        document.getElementById('dateInput').addEventListener('change', redrawCanvas);
        
        document.getElementById('dateInput').valueAsDate = new Date();
        
        redrawCanvas();
    </script>
</body>
</html>
